<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat en WebSocket avec vidéo synchronisée</title>
  <style>
    #chat { display: none; }
    #messages {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
    }
    #input { width: 80%; padding: 8px; }
    #send { width: 18%; padding: 8px; }
  </style>
</head>
<body style="background-color: antiquewhite;">
  <h1>Salon de discussion</h1>
  <button id="join">Join</button>

  <div id="chat">
    <button id="close">Fermer</button>
    <table>
      <tr>
        <td>
          <div id="video">
            <!-- On remplace l'image par une vidéo avec un exemple de source random -->
            <video id="syncVideo" width="400" controls>
              <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
              Ton navigateur ne supporte pas la vidéo.
            </video>
          </div>
        </td>
        <td>
          <div id="messages" style="width: 500px; height: 427px; background-color: white;"></div>
        </td>
      </tr>
    </table>
    <button id="opn-msg-btn" style="background-color: rgb(129, 192, 35);">Créer un message</button>
    <div id="send-form" style="background-color: azure; width: 400px; margin-top: 10px; display:none;">
      <button id="cls-msg-btn" style="background-color: red;">X</button>
      <input type="text" id="pseudo" placeholder="Ton pseudo" autofocus><br>
      <input type="text" id="input" style="width:300px" placeholder="Écris ton message..."><br><br>
      <button id="send">Envoyer</button>
    </div>
  </div>

  <script>
    let ws;
    const joinButton = document.getElementById('join');
    const chatDiv = document.getElementById('chat');
    const messagesDiv = document.getElementById('messages');
    const pseudoInput = document.getElementById('pseudo');
    const input = document.getElementById('input');
    const sendButton = document.getElementById('send');
    const closeButton = document.getElementById('close');
    const openMsgButton = document.getElementById('opn-msg-btn');
    const closeMsgButton = document.getElementById('cls-msg-btn');
    const sendForm = document.getElementById('send-form');
    
    // Pour la vidéo synchronisée
    const syncVideo = document.getElementById('syncVideo');
    let isSyncing = false; // Flag pour différencier les actions locales et les syncs distants

    // Connexion au serveur WebSocket lors du clic sur "Join"
    joinButton.addEventListener('click', () => {
      joinButton.style.display = 'none';
      chatDiv.style.display = 'block';
      ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        console.log('Connecté au serveur WebSocket.');
      };

      ws.onmessage = (event) => {
        // Tenter de parser le message reçu en JSON
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          // Ce n'est pas du JSON, c'est un message de chat classique
          const p = document.createElement('p');
          p.textContent = event.data;
          messagesDiv.appendChild(p);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          return;
        }

        // Vérifier si c'est un message vidéo synchronisé
        if (data.type && data.type === "video") {
          console.log("Commande vidéo reçue :", data);
          // Appliquer la synchronisation sans déclencher à nouveau les événements
          isSyncing = true;
          if (data.action === "pause") {
            syncVideo.pause();
            syncVideo.currentTime = data.timestamp;
          } else if (data.action === "play") {
            syncVideo.currentTime = data.timestamp;
            syncVideo.play();
          }
          isSyncing = false;
        } else if (data.pseudo && data.message) {
          // Message de chat
          const p = document.createElement('p');
          p.textContent = `[${data.pseudo}] ${data.message}`;
          messagesDiv.appendChild(p);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      };

      ws.onerror = (error) => {
        console.error('Erreur WebSocket :', error);
      };

      ws.onclose = () => {
        console.log('Connexion fermée.');
      };
    });

    // Envoi d'un message de chat
    sendButton.addEventListener('click', () => {
      if (input.value.trim() !== '' && pseudoInput.value.trim() !== '') {
        const data = {
          pseudo: pseudoInput.value.trim(),
          message: input.value.trim()
        };
        ws.send(JSON.stringify(data));
        input.value = '';
      }
    });

    input.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });

    closeButton.addEventListener('click', () => {
      if (ws) {
        ws.close();
      }
      chatDiv.style.display = 'none';
      messagesDiv.innerHTML = '';
      joinButton.style.display = 'block';
    });

    openMsgButton.addEventListener('click', () => {
      sendForm.style.display = 'block';
    });

    closeMsgButton.addEventListener('click', () => {
      sendForm.style.display = 'none';
    });

    // Écoute des événements du lecteur vidéo pour synchroniser lecture/pause
    syncVideo.addEventListener('pause', () => {
      if (!isSyncing) {
        const message = {
          type: "video",
          action: "pause",
          timestamp: syncVideo.currentTime
        };
        ws.send(JSON.stringify(message));
        console.log("Commande pause envoyée :", message);
      }
    });

    syncVideo.addEventListener('play', () => {
      if (!isSyncing) {
        const message = {
          type: "video",
          action: "play",
          timestamp: syncVideo.currentTime
        };
        ws.send(JSON.stringify(message));
        console.log("Commande play envoyée :", message);
      }
    });
  </script>
</body>
</html>